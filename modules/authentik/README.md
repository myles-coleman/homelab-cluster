# Authentik Forward Authentication Module

This Terragrunt module automates the configuration of Authentik for forward authentication with Traefik.

## What It Creates

1. **API Token** - For the Authentik outpost to communicate with the server
2. **Proxy Providers** - One for each application you want to protect
3. **Applications** - Links providers to the Authentik UI
4. **Outpost** - The forward auth service that Traefik will query

## Prerequisites

### 1. Authentik Must Be Running

Ensure Authentik is deployed and accessible:
```bash
kubectl get pods -n authentik
```

### 2. Create Authentik API Token

1. Log into Authentik admin interface
2. Navigate to **Directory → Tokens & App passwords**
3. Click **Create** → **Token**
4. Set:
   - **Identifier**: `terraform-admin-token`
   - **User**: Select admin user (or create dedicated service account)
   - **Intent**: API Token
   - **Expiring**: No (or set far future date)
5. Copy the token value

### 3. Update Configuration

Edit `common-inputs.yaml`:
```yaml
authentik_url: https://authentik.cowlab.org
authentik_token: YOUR_TOKEN_HERE  # Paste the token from step 2
authentik_outpost_user_id: 1  # User ID for outpost (1 = akadmin, or create service account)
domain: cowlab.org
```

**Security Note**: Consider storing `authentik_token` in a secure secret manager instead of `common-inputs.yaml`.

## Usage

### Deploy the Module

```bash
cd modules/authentik-forward-auth
terragrunt plan
terragrunt apply
```

### Get the Outpost Token

After applying, retrieve the outpost token:

```bash
terragrunt output -raw outpost_token
```

This token needs to be stored in Kubernetes for the outpost deployment.

### Update External Secret

Edit `manifests/cluster/authentik/external-secret.yaml` and add the outpost token to your secrets backend, then update the `remoteRef.key` to point to it.

Or create a Kubernetes secret directly:
```bash
kubectl create secret generic authentik-outpost-token \
  -n authentik \
  --from-literal=token="$(cd modules/authentik-forward-auth && terragrunt output -raw outpost_token)"
```

### Deploy Kubernetes Resources

```bash
kubectl apply -k manifests/cluster/authentik/
kubectl apply -k manifests/cluster/traefik/
```

## Adding Applications

To protect additional applications, edit `terragrunt.hcl`:

```hcl
applications = {
  myapp = {
    name          = "My Application"
    slug          = "myapp"
    external_host = "https://myapp.cowlab.org"
    mode          = "forward_single"
  }
}
```

Then apply:
```bash
terragrunt apply
```

### Forward Auth Modes

- **`forward_single`** - Single application mode (requires callback route in IngressRoute)
- **`forward_domain`** - Domain-level mode (protects entire domain, no callback needed)
- **`proxy`** - Full reverse proxy mode (Authentik proxies all traffic)

## Module Structure

```
authentik-forward-auth/
├── _backend.tf          # Generated by Terragrunt
├── _provider.tf         # Generated by Terragrunt
├── _terraform.tf        # Provider requirements
├── _variables.tf        # Input variables
├── _outputs.tf          # Output values
├── flows.tf             # Data sources for Authentik flows
├── token.tf             # Outpost API token
├── providers.tf         # Proxy providers for each app
├── applications.tf      # Authentik applications
├── outpost.tf           # Authentik outpost configuration
├── terragrunt.hcl       # Terragrunt configuration
└── README.md            # This file
```

## Outputs

- `outpost_token` - The API token for the outpost (sensitive)
- `outpost_token_id` - The ID of the token resource
- `outpost_id` - The ID of the outpost
- `applications` - Map of created applications
- `providers` - Map of created providers

## Workflow

```
1. Generate Authentik admin API token (manual)
   ↓
2. Update common-inputs.yaml with token
   ↓
3. Run terragrunt apply
   ↓
4. Terraform creates:
   - Outpost token
   - Proxy providers
   - Applications
   - Outpost
   ↓
5. Get outpost token from terraform output
   ↓
6. Store outpost token in Kubernetes secret
   ↓
7. Deploy outpost deployment
   ↓
8. Deploy Traefik middleware
   ↓
9. Update application IngressRoutes
   ↓
10. Test authentication
```

## Troubleshooting

### Provider Authentication Error

**Error**: `Error: failed to authenticate`

**Solution**: Verify `authentik_token` in `common-inputs.yaml` is correct and has API access.

### Flow Not Found

**Error**: `Error: flow with slug "default-provider-authorization-implicit-consent" not found`

**Solution**: Ensure Authentik is fully initialized. These flows are created during initial setup.

### Outpost Not Appearing in UI

**Solution**: Check Terraform outputs and verify the outpost was created:
```bash
terragrunt output outpost_id
```

Then check in Authentik UI: **Applications → Outposts**

## Security Best Practices

1. **Use a dedicated service account** for the outpost token instead of admin user
2. **Store tokens in a secret manager** (AWS Secrets Manager, Vault, etc.)
3. **Rotate tokens regularly**
4. **Use least privilege** - create service account with only necessary permissions
5. **Enable MFA** for all admin accounts in Authentik

## References

- [Authentik Terraform Provider](https://registry.terraform.io/providers/goauthentik/authentik/latest/docs)
- [Authentik Forward Auth Documentation](https://docs.goauthentik.io/add-secure-apps/providers/proxy/server_traefik/)
- [Forward Auth Setup Guide](../../docs/operator-guide/runbooks/forward-auth-setup.md)

## Next Steps

After deploying this module:

1. ✅ Verify outpost appears in Authentik UI
2. ✅ Store outpost token in Kubernetes
3. ✅ Deploy outpost deployment
4. ✅ Deploy Traefik middleware
5. ✅ Update application IngressRoutes
6. ✅ Test authentication flow
7. ✅ Enable MFA in Authentik
8. ✅ Configure access policies
