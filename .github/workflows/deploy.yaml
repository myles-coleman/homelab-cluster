name: Deploy Terraform

on:
  pull_request:
    paths:
      - "modules/**"
  push:
    branches:
      - main
    paths:
      - "modules/**"
  workflow_dispatch: {}

concurrency:
  group: deploy
  cancel-in-progress: false

env:
  tg_version: '0.97.2'
  tofu_version: '1.11.2'
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  plan:
    name: Plan (${{ matrix.module }})
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - argocd-configure
          - argocd-install
          - cloudflare
          - s3-backups
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
      GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
      ALLOWED_EMAILS: ${{ vars.ALLOWED_EMAILS }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8 #v5.1.0
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Terragrunt and OpenTofu
        uses: gruntwork-io/terragrunt-action@5e86476ca61eaf74adb9c0525745f29f921f2199 # v3.1.0
        with:
          tg_version: ${{ env.tg_version }}
          tofu_version: ${{ env.tofu_version }}

      - name: Tailscale
        uses: tailscale/github-action@53acf823325fe9ca47f4cdaa951f90b4b0de5bb9 # v4.1.1
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Accept Tailscale routes
        run: sudo tailscale set --accept-routes

      # Accepting Tailscale routes breaks DNS resolution (systemd-resolved at
      # 127.0.0.53 times out). Override with Google public DNS to restore
      # connectivity to AWS and other external services.
      - name: Fix DNS resolution
        run: |
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
          echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf > /dev/null

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Terraform Format
        run: tofu fmt -check -recursive
        working-directory: ./modules/${{ matrix.module }}

      - name: Terragrunt Validate
        run: terragrunt validate
        working-directory: ./modules/${{ matrix.module }}

      - name: Terragrunt Plan
        env:
          TF_IN_AUTOMATION: true
        run: |
          terragrunt plan -out=tfplan-${{ matrix.module }}.tfplan
          terragrunt show -json tfplan-${{ matrix.module }}.tfplan > tfplan-${{ matrix.module }}.json
        working-directory: ./modules/${{ matrix.module }}

      - name: Comment Plan Changes
        if: github.event_name == 'pull_request'
        uses: liatrio/terraform-change-pr-commenter@0050454ca62e2839dc35022bfbd474a139c2c65d #v1.14.0
        with:
          json-file: ./modules/${{ matrix.module }}/tfplan-${{ matrix.module }}.json
          comment-header: "Terraform Plan for ${{ matrix.module }}"
          expand-comment: 'true'
          hide-previous-comments: 'true'
          log-changed-resources: 'false'
          include-workflow-link: 'true'
          quiet: 'true'

  apply:
    name: Apply
    needs: plan
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    environment: deploy
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
      GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
      ALLOWED_EMAILS: ${{ vars.ALLOWED_EMAILS }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8 #v5.1.0
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Terragrunt and OpenTofu
        uses: gruntwork-io/terragrunt-action@5e86476ca61eaf74adb9c0525745f29f921f2199 # v3.1.0
        with:
          tg_version: ${{ env.tg_version }}
          tofu_version: ${{ env.tofu_version }}

      - name: Tailscale
        uses: tailscale/github-action@53acf823325fe9ca47f4cdaa951f90b4b0de5bb9 # v4.1.1
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Accept Tailscale routes
        run: sudo tailscale set --accept-routes

      # Accepting Tailscale routes breaks DNS resolution (systemd-resolved at
      # 127.0.0.53 times out). Override with Google public DNS to restore
      # connectivity to AWS and other external services.
      - name: Fix DNS resolution
        run: |
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
          echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf > /dev/null

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Terraform Format
        run: tofu fmt -check -recursive

      - name: Terragrunt Validate
        run: terragrunt validate -all

      - name: Terragrunt Apply
        uses: gruntwork-io/terragrunt-action@95fc057922e3c3d4cc021a81a213f088f333ddef # v3.0.2
        with:
          tg_version: ${{ env.tg_version }}
          tofu_version: ${{ env.tofu_version }}
          tg_command: "apply --all --non-interactive"
          tg_add_approve: true
